/*! Known 2018-08-15 */
"use strict";var Unfurl=Unfurl||{};Unfurl.fetch=function(a,b){a.length>0&&Security.getCSRFToken(function(c,d){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:a,__bTk:c,__bTs:d},function(a){b(a)})},known.config.displayUrl+"service/web/unfurl/")},Unfurl.getUrls=function(a){console.log(a);var b=new RegExp("(https?://[^\\s]+)","gi");return a.match(b)},Unfurl.getFirstUrl=function(a){var b=Unfurl.getUrls(a);return void 0!=b&&b.length>0?b[0]:""},Unfurl.initOembed=function(a){var b=a.find("div.oembed");if(void 0!=b){var c=b.attr("data-url"),d=b.attr("data-format");void 0!=c&&(console.log("Fetching oembed code from "+c+" using "+d),$.ajax({url:c,dataType:d,success:function(a){if(console.log("Got a response back"),"xml"==d){console.log("XML Format");var c=$(a),e=c.find("html").text();e.indexOf("CDATA")>-1&&(e=e.substr(9,e.length-12)),b.html(e)}else console.log("JSON Format"),b.html(a.html);b.closest(".unfurled-url").find(".basics").hide()}}))}},Unfurl.enableControls=function(a){var b=a.attr("data-url"),c=a.closest(".unfurl-block"),d=c.find(".unfurl-edit a.refresh"),e=c.find(".unfurl-edit a.delete");d.click(function(c){Security.getCSRFToken(function(c,d){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:b,forcenew:!0,__bTk:c,__bTs:d},success:function(b){console.log("Refreshed"),a.fadeOut().fadeIn(),Unfurl.unfurl(a)}})},known.config.displayUrl+"service/web/unfurl/"),c.preventDefault()}),e.click(function(a){Security.getCSRFToken(function(a,b){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+c.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:a,__bTs:b},success:function(a){console.log("Refresh: deleted"),c.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+c.attr("data-parent-object")+"/"),a.preventDefault()})},Unfurl.unfurl=function(a){var b=a.attr("data-url");void 0!=b&&Unfurl.fetch(b,function(b){a.html(b.rendered),a.show(),Unfurl.initOembed(a),Template.enableImageFallback(),Unfurl.enableControls(a)})},Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})},$(document).ready(function(){Unfurl.unfurlAll()});